---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Standings from "../components/Standings.astro";
import Matchups from "../components/Matchups.astro";
import BubbleEliminated from "../components/BubbleEliminated.astro";
import Footer from "../components/Footer.astro";
import ScheduleModal from "../components/ScheduleModal.astro";
import PowerRankings from "../components/PowerRankings.astro";
import fs from "node:fs";
import path from "node:path";

// Load data using Node fs
const standingsPath = path.resolve("./src/data/standings.json");
const standings = JSON.parse(fs.readFileSync(standingsPath, "utf-8"));

const playoffPicturePath = path.resolve("./src/data/playoff-picture.json");
const playoffPicture = JSON.parse(fs.readFileSync(playoffPicturePath, "utf-8"));

// Use today's date or a specific timestamp from data if available
const lastUpdated = new Date().toLocaleString("en-US", {
	timeZone: "America/New_York",
	day: "numeric",
	month: "long",
	hour: "2-digit",
	minute: "2-digit",
});
---

<Layout title="NFL Playoff Picture 2025">
	<Header />
	<main>
		<div class="content-wrapper">
			<h1 class="main-title">
				<span class="highlight">NFL</span> PLAYOFF PICTURE <span
					class="year">2025</span
				>
			</h1>
			<p class="last-updated">Last update : {lastUpdated}</p>

			<div id="install-container" class="install-container" hidden>
				<button id="install-pwa" class="install-btn">
					<svg
						width="20"
						height="20"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
					>
						<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
						></path>
						<polyline points="7 10 12 15 17 10"></polyline>
						<line x1="12" y1="15" x2="12" y2="3"></line>
					</svg>
					Install App
				</button>
				<p class="install-text">
					super lightweight PWA App that can load offline with your
					preference saved, until next app datas update
				</p>
			</div>

			<script>
				const installContainer =
					document.getElementById("install-container");
				const installBtn = document.getElementById("install-pwa");

				// Check if app is already installed/running in standalone mode
				const isStandalone = window.matchMedia(
					"(display-mode: standalone)",
				).matches;

				if (!isStandalone) {
					// Check if event already fired before this script ran
					if (window.deferredPrompt) {
						installContainer?.removeAttribute("hidden");
					}

					// Listen for event
					window.addEventListener("pwa-install-available", () => {
						installContainer?.removeAttribute("hidden");
					});
				}

				// Listen for successful install to hide button immediately
				window.addEventListener("appinstalled", () => {
					installContainer?.setAttribute("hidden", "");
					window.deferredPrompt = null;
				});

				installBtn?.addEventListener("click", async () => {
					if (!window.deferredPrompt) return;

					// Show the install prompt
					window.deferredPrompt.prompt();

					// Wait for the user to respond to the prompt
					const { outcome } = await window.deferredPrompt.userChoice;
					console.log(
						`User response to the install prompt: ${outcome}`,
					);

					// We've used the prompt, and can't use it again, throw it away
					window.deferredPrompt = null;

					// Hide button
					installContainer?.setAttribute("hidden", "");
				});
			</script>

			<section id="matchups">
				<Matchups
					afc={standings.AFC}
					nfc={standings.NFC}
					seeds={playoffPicture.seeds}
				/>
			</section>

			<BubbleEliminated
				bubble={playoffPicture.bubble}
				eliminated={playoffPicture.eliminated}
			/>

			<section id="power-rankings">
				<PowerRankings rankings={playoffPicture.powerRankings} />
			</section>

			<section id="standings">
				<Standings afc={standings.AFC} nfc={standings.NFC} />
			</section>
		</div>
	</main>
	<ScheduleModal />
	<Footer />
</Layout>

<style lang="scss">
	html {
		scroll-behavior: smooth;
		scroll-padding-top: 100px; /* Offset for sticky header */
	}

	main {
		min-height: 80vh;
		padding-top: 2rem;
	}

	.content-wrapper {
		max-width: 1200px;
		margin: 0 auto;
	}

	.main-title {
		text-align: center;
		font-size: 2.5rem;
		font-weight: 900;
		line-height: 1.1;
		margin-bottom: 0.5rem;
		letter-spacing: -1px;
		text-transform: uppercase;
		background: linear-gradient(180deg, #fff 0%, #aaa 100%);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));

		.highlight {
			font-weight: 900;
			font-style: italic;
		}

		.year {
			font-weight: 300;
			color: var(--nfl-red);
			-webkit-text-fill-color: var(--nfl-red);
		}
	}

	.last-updated {
		text-align: center;
		color: var(--text-secondary);
		font-size: 0.9rem;
		margin-bottom: 2rem;
		font-family: var(--font-body);
	}

	.install-container {
		display: flex;
		flex-direction: column;
		align-items: center;
		margin: -1rem auto 0;
		text-align: center;

		&[hidden] {
			display: none;
		}
	}

	.install-text {
		font-size: 0.8rem;
		color: var(--text-secondary);
		margin-top: 0.5rem;
		max-width: 300px;
		line-height: 1.4;
	}

	.install-btn {
		display: flex;
		align-items: center;
		gap: 8px;
		margin: 0; // Margin handled by container
		background-color: var(--nfl-blue);
		color: white;
		border: none;
		padding: 0.6rem 1.2rem;
		border-radius: 25px;
		font-weight: 600;
		cursor: pointer;
		transition:
			transform 0.2s,
			background-color 0.2s;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);

		&:hover {
			transform: translateY(-2px);
			background-color: #004da1;
		}

		&:active {
			transform: translateY(0);
		}

		svg {
			stroke: currentColor;
		}
	}

	@media (min-width: 768px) {
		.main-title {
			font-size: 4rem;
		}
	}
</style>
