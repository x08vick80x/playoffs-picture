---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Standings from "../components/Standings.astro";
import Matchups from "../components/Matchups.astro";
import BubbleEliminated from "../components/BubbleEliminated.astro";
import MyTeams from "../components/MyTeams.astro";
import Footer from "../components/Footer.astro";
import ScheduleModal from "../components/ScheduleModal.astro";
import PowerRankings from "../components/PowerRankings.astro";
import PageTitle from "../components/atoms/PageTitle.astro";
import LastUpdated from "../components/atoms/LastUpdated.astro";
import Button from "../components/atoms/Button.astro";
import fs from "node:fs";

import path from "node:path";

// Load data using Node fs
const standingsPath = path.resolve("./src/data/standings.json");
const standings = JSON.parse(fs.readFileSync(standingsPath, "utf-8"));

const playoffPicturePath = path.resolve("./src/data/playoff-picture.json");
const playoffPicture = JSON.parse(fs.readFileSync(playoffPicturePath, "utf-8"));

// Use today's date or a specific timestamp from data if available
const lastUpdated = new Date().toLocaleString("en-US", {
	timeZone: "America/New_York",
	day: "numeric",
	month: "long",
	hour: "2-digit",
	minute: "2-digit",
});
---

<Layout title="NFL Playoff Picture 2025">
	<Header />
	<main>
		<div class="content-wrapper">
			<PageTitle />
			<LastUpdated date={lastUpdated} />

			<div id="install-container" class="install-container" hidden>
				<Button id="install-pwa">
					<svg
						width="20"
						height="20"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
					>
						<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
						></path>
						<polyline points="7 10 12 15 17 10"></polyline>
						<line x1="12" y1="15" x2="12" y2="3"></line>
					</svg>
					Install App
				</Button>
				<p class="install-text">
					super lightweight PWA App that can load offline with your
					preference saved, until next app datas update
				</p>
			</div>

			<MyTeams standings={standings} playoffPicture={playoffPicture} />

			<script>
				const installContainer =
					document.getElementById("install-container");
				const installBtn = document.getElementById("install-pwa");
				const myTeamsRoot = document.getElementById("my-teams-root");

				// Check if app is already installed/running in standalone mode
				const isStandalone = window.matchMedia(
					"(display-mode: standalone)",
				).matches;

				if (isStandalone) {
					// Standalone: Hide install, Show My Teams
					if (installContainer) installContainer.hidden = true;
					if (myTeamsRoot) myTeamsRoot.hidden = false;
				} else {
					// Browser Mode: Hide My Teams default (will show install if available logic runs)
					if (myTeamsRoot) myTeamsRoot.hidden = true;

					// Check if event already fired before this script ran
					if (window.deferredPrompt) {
						installContainer?.removeAttribute("hidden");
					}

					// Listen for event
					window.addEventListener("pwa-install-available", () => {
						installContainer?.removeAttribute("hidden");
						// Hide MyTeams if install available (reinforces logic)
						if (myTeamsRoot) myTeamsRoot.hidden = true;
					});
				}

				// Listen for successful install to switch views
				window.addEventListener("appinstalled", () => {
					installContainer?.setAttribute("hidden", "");
					window.deferredPrompt = null;
					console.log("App Installed - Switching to My Teams view");
					if (myTeamsRoot) myTeamsRoot.hidden = false;
				});

				installBtn?.addEventListener("click", async () => {
					if (!window.deferredPrompt) return;

					// Show the install prompt
					window.deferredPrompt.prompt();

					// Wait for the user to respond to the prompt
					const { outcome } = await window.deferredPrompt.userChoice;
					console.log(
						`User response to the install prompt: ${outcome}`,
					);

					// We've used the prompt, and can't use it again, throw it away
					window.deferredPrompt = null;
					// UI update handled by appinstalled listener
				});
			</script>

			<section id="matchups">
				<Matchups
					afc={standings.AFC}
					nfc={standings.NFC}
					seeds={playoffPicture.seeds}
				/>
			</section>

			<BubbleEliminated
				bubble={playoffPicture.bubble}
				eliminated={playoffPicture.eliminated}
			/>

			<section id="power-rankings">
				<PowerRankings rankings={playoffPicture.powerRankings} />
			</section>

			<section id="standings">
				<Standings afc={standings.AFC} nfc={standings.NFC} />
			</section>
		</div>
	</main>
	<ScheduleModal />
	<Footer />
</Layout>

<style lang="scss">
	html {
		scroll-behavior: smooth;
		scroll-padding-top: 100px; /* Offset for sticky header */
	}

	main {
		min-height: 80vh;
		padding-top: 2rem;
	}

	.content-wrapper {
		max-width: 1200px;
		margin: 0 auto;
	}

	.install-container {
		display: flex;
		flex-direction: column;
		align-items: center;
		margin: -1rem auto 0;
		text-align: center;

		&[hidden] {
			display: none;
		}
	}

	.install-text {
		font-size: 0.8rem;
		color: var(--text-secondary);
		margin-top: 0.5rem;
		max-width: 300px;
		line-height: 1.4;
	}
</style>
