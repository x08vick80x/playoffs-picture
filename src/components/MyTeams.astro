---
import { getTeamId, getTeamAbbreviation } from "../utils/team-mapping.js";

const { standings, playoffPicture } = Astro.props;

// Build Master Map for Client
// We need to handle mapping from "City" (Standings) to "ID" and "Abbr"
const masterTeamMap = {};

// Helper to normalized name
const normalize = (name) => name.trim();

["AFC", "NFC"].forEach((conf) => {
    standings[conf].forEach((team) => {
        const name = normalize(team.team);
        masterTeamMap[name] = {
            id: getTeamId(name),
            abbr: getTeamAbbreviation(name),
            conf: conf,
        };
    });
});

// Pass data to client-side script
const teamsData = {
    standings,
    playoffPicture,
    masterMap: masterTeamMap,
};
---

<div id="my-teams-root" class="my-teams-container" hidden>
    <div id="mt-intro" class="mt-intro">
        <h2>My Teams</h2>
        <button
            id="btn-edit-teams"
            class="icon-btn"
            aria-label="Edit Favorites"
        >
            <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="M11 4H4a2 0 0 0-2 2v14a2 0 0 0 2 2h14a2 0 0 0 2-2v-7"
                ></path><path
                    d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path></svg
            >
        </button>
    </div>

    <div id="mt-dashboard" class="mt-dashboard grid-container">
        <!-- Cards will be injected here -->
        <p class="empty-msg">No teams selected.</p>
    </div>

    <!-- Modal Overlay -->
    <div id="mt-selector-modal" class="modal-overlay" hidden>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Favorites</h3>
                <button id="btn-close-modal" class="close-btn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="team-grid" id="team-checklist">
                    <!-- Cards injected here -->
                </div>
            </div>

            <div class="modal-footer">
                <button id="btn-save-teams" class="save-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ teamsData }}>
    // --- Data Helpers ---
    const resolveTeamKey = (inputName) => {
        if (teamsData.masterMap[inputName]) return inputName;
        const inputParts = inputName.split(" ");
        const inputLast = inputParts[inputParts.length - 1]; // "Bills"
        for (const [key, meta] of Object.entries(teamsData.masterMap)) {
            if (meta.id === inputLast.toLowerCase()) return key;
            if (key.includes(inputName) || inputName.includes(key)) return key;
        }
        return null;
    };

    function getTeamStats(cityKey) {
        const meta = teamsData.masterMap[cityKey];
        if (!meta) return null;

        let stats = {
            name: cityKey,
            abbr: meta.abbr,
            id: meta.id,
            seed: null,
            record: "0-0",
            probability: "N/A",
            nextOpp: null,
            isInProjected: false,
            isBubble: false,
            isEliminated: false,
            schedule: [],
        };

        const standingsRow = teamsData.standings[meta.conf].find(
            (t) => t.team === cityKey,
        );
        if (standingsRow) stats.record = standingsRow.record;

        const seedRow = teamsData.playoffPicture.seeds[meta.conf].find(
            (t) => resolveTeamKey(t.name) === cityKey,
        );
        if (seedRow) {
            stats.isInProjected = true;
            stats.seed = seedRow.seed;
            stats.probability = seedRow.probability;
            stats.nextOpp = seedRow.nextOpponent;
            stats.schedule = seedRow.remainingSchedule;
        } else {
            const bubbleRow = teamsData.playoffPicture.bubble[meta.conf].find(
                (t) => resolveTeamKey(t.name) === cityKey,
            );
            if (bubbleRow) {
                stats.isBubble = true;
                stats.probability = bubbleRow.probability;
                stats.nextOpp = bubbleRow.nextOpponent;
                stats.schedule = bubbleRow.remainingSchedule;
            } else {
                const elimRow = teamsData.playoffPicture.eliminated[
                    meta.conf
                ].find((t) => resolveTeamKey(t.name) === cityKey);
                if (elimRow) {
                    stats.isEliminated = true;
                    stats.probability = elimRow.probability || "0%";
                }
            }
        }
        return stats;
    }

    // --- UI Logic ---
    const root = document.getElementById("my-teams-root");
    const dashboard = document.getElementById("mt-dashboard");
    const modal = document.getElementById("mt-selector-modal");
    const checklist = document.getElementById("team-checklist");
    const btnEdit = document.getElementById("btn-edit-teams");
    const btnSave = document.getElementById("btn-save-teams");
    const btnClose = document.getElementById("btn-close-modal");

    const STORAGE_KEY = "nfl-favorites";
    let myTeams = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    // Temp set for editing before save
    let editSet = new Set(myTeams);

    // Render Grid in Modal
    function renderSelector() {
        checklist.innerHTML = "";
        // Sort keys properly
        const keys = Object.keys(teamsData.masterMap).sort();

        keys.forEach((teamRaw) => {
            const meta = teamsData.masterMap[teamRaw];
            const isSelected = editSet.has(teamRaw);

            const card = document.createElement("div");
            card.className = `select-card ${isSelected ? "selected" : ""}`;
            card.onclick = () => toggleSelection(teamRaw, card);

            card.innerHTML = `
                <div class="card-content">
                    <svg class="team-logo" width="40" height="40">
                        <use href="/sprites.svg#${meta.id}" />
                    </svg>
                    <span class="team-abbr">${meta.abbr}</span>
                </div>
                <!-- Checkmark Icon (visible only when selected) -->
                ${isSelected ? '<div class="check-badge">✓</div>' : ""}
            `;
            checklist.appendChild(card);
        });
    }

    function toggleSelection(teamRaw, cardEl) {
        if (editSet.has(teamRaw)) {
            editSet.delete(teamRaw);
            cardEl.classList.remove("selected");
            const check = cardEl.querySelector(".check-badge");
            if (check) check.remove();
        } else {
            editSet.add(teamRaw);
            cardEl.classList.add("selected");
            if (!cardEl.querySelector(".check-badge")) {
                cardEl.insertAdjacentHTML(
                    "beforeend",
                    '<div class="check-badge">✓</div>',
                );
            }
        }
    }

    function renderDashboard() {
        dashboard.innerHTML = "";
        if (myTeams.length === 0) {
            dashboard.innerHTML = `<button id="btn-empty-start" class="empty-start-btn">Select Teams +</button>`;
            document.getElementById("btn-empty-start").onclick = openModal;
            return;
        }

        myTeams.forEach((teamKey) => {
            const stats = getTeamStats(teamKey);
            if (!stats) return;

            const card = document.createElement("div");
            card.className = "team-item";

            let probColorClass = "";
            if (stats.isInProjected) probColorClass = "text-green";
            else if (stats.isBubble) probColorClass = "text-red";
            else if (stats.isEliminated) probColorClass = "text-gray";

            let nextOppHtml = "";
            if (stats.nextOpp) {
                const scheduleJson = JSON.stringify(stats.schedule || []);
                nextOppHtml = `
                    <div class="next-opp-container">
                        <span class="next-opp">nxt ${stats.nextOpp.location} ${stats.nextOpp.opponent}</span>
                         <button class="schedule-btn team-card-trigger"
                            data-team="${stats.name}"
                            data-schedule='${scheduleJson}'>+</button>
                    </div>
                `;
            } else if (stats.isInProjected) {
                nextOppHtml = `<span class="next-opp">-</span>`;
            }

            const seedHtml = stats.seed
                ? `<span class="seed-badge">#${stats.seed}</span>`
                : "";

            card.innerHTML = `
                <div class="team-info">
                    <svg class="team-logo" width="32" height="32">
                        <use href="/sprites.svg#${stats.id}" />
                    </svg>
                    <span class="team-abbr">${stats.abbr}</span>
                </div>

                <div class="team-stats">
                     <span class="team-record">${seedHtml} ${stats.record}</span>
                     ${
                         stats.probability !== "N/A"
                             ? `
                        <div class="team-prob">
                            <span class="prob-label">PROB</span>
                            <span class="prob-value ${probColorClass}">${stats.probability}</span>
                        </div>
                     `
                             : ""
                     }
                     ${nextOppHtml}
                </div>
            `;
            dashboard.appendChild(card);
        });
    }

    function openModal() {
        editSet = new Set(myTeams);
        renderSelector();
        modal.hidden = false;
        // Fix body scroll
        document.body.style.overflow = "hidden";
    }

    function closeModal() {
        modal.hidden = true;
        document.body.style.overflow = "";
    }

    btnEdit.addEventListener("click", openModal);
    btnClose.addEventListener("click", closeModal);

    btnSave.addEventListener("click", () => {
        myTeams = Array.from(editSet);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(myTeams));
        renderDashboard();
        closeModal();
    });

    // Close on outside click
    modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
    });

    renderDashboard();

    window.addEventListener("appinstalled", () => {
        root.hidden = false;
    });
</script>

<style lang="scss">
    .my-teams-container {
        margin: 1rem auto;
        padding: 0 1rem;
        max-width: 1000px;
    }

    .mt-intro {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5rem;

        h2 {
            font-size: 1.2rem;
            color: #aaa;
            text-transform: uppercase;
            font-weight: 800;
            margin: 0;
        }

        .icon-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            &:hover {
                color: white;
            }
        }
    }

    .grid-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.8rem;
        @media (min-width: 768px) {
            grid-template-columns: 1fr 1fr;
        }
    }

    .empty-start-btn {
        width: 100%;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.05);
        border: 2px dashed rgba(255, 255, 255, 0.2);
        color: #aaa;
        font-size: 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        &:hover {
            border-color: var(--nfl-blue);
            color: white;
        }
    }

    /* --- Team Card Styles (Identical to Bubble style) --- */
    .team-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        transition:
            transform 0.2s,
            background 0.2s;

        &:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 1rem;

            .team-logo {
                width: 36px;
                height: 36px;
            }
            .team-abbr {
                font-size: 1.4rem;
                font-weight: 900;
                color: white;
            }
        }

        .team-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .team-record {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-family: monospace;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .seed-badge {
            background: var(--nfl-blue);
            color: white;
            font-size: 0.7rem;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .team-prob {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: bold;

            .prob-label {
                color: #666;
                font-size: 0.7rem;
            }
            .prob-value {
                color: white;
            }
            .text-green {
                color: var(--nfl-green);
            }
            .text-red {
                color: var(--nfl-red);
            }
            .text-gray {
                color: #666;
            }
        }

        .next-opp-container {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 2px;

            .next-opp {
                font-size: 0.8rem;
                color: #888;
            }

            .schedule-btn {
                background: #333;
                border: 1px solid #555;
                color: #ccc;
                border-radius: 4px;
                width: 18px;
                height: 18px;
                font-size: 14px;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                cursor: pointer;

                &:hover {
                    background: #555;
                    color: white;
                }
            }
        }
    }

    /* --- Modal Styles --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: flex-end; // Bottom sheet on mobile? Or center?
        @media (min-width: 600px) {
            align-items: center;
        }
    }

    .modal-content {
        background: var(--bg-card);
        width: 100%;
        max-width: 600px;
        height: 85vh; // Almost full height
        border-radius: 20px 20px 0 0; // Rounded top
        display: flex;
        flex-direction: column;
        border: 1px solid #333;

        @media (min-width: 600px) {
            height: 80vh;
            border-radius: 12px;
        }
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;

        h3 {
            margin: 0;
            color: white;
            font-size: 1.2rem;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #aaa;
            cursor: pointer;
        }
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .team-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .select-card {
        background: #1a1a1a;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 1rem 0.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;

        &:hover {
            background: #222;
        }

        .card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .team-logo {
            width: 48px;
            height: 48px;
        }
        .team-abbr {
            font-weight: 800;
            font-size: 1.1rem;
            color: #888;
        }

        &.selected {
            border-color: var(--nfl-green);
            background: rgba(74, 222, 128, 0.1);

            .team-abbr {
                color: white;
            }
        }

        .check-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: var(--nfl-green);
            color: black;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #333;
        background: var(--bg-card); // Sticky-ish
    }

    .save-btn {
        width: 100%;
        background: var(--nfl-red);
        color: white;
        border: none;
        padding: 1rem;
        border-radius: 50px; // Pill shape
        font-size: 1.2rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        transition: background 0.3s;

        &:hover {
            background: #cc0000;
        }
    }

    .empty-msg {
        text-align: center;
        color: #666;
        font-style: italic;
    }
</style>
